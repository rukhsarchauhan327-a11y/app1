<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Cart - Kirana Konnect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script> window.FontAwesomeConfig = { autoReplaceSvg: 'nest'};</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>::-webkit-scrollbar { display: none;}</style>
    
    <script>tailwind.config = {
  "theme": {
    "extend": {
      "colors": {
        "primary": "#4CAF50",
        "secondary": "#2196F3",
        "accent": "#FF9800",
        "danger": "#F44336",
        "dark": "#333333",
        "light": "#F5F5F5"
      },
      "fontFamily": {
        "poppins": [
          "Poppins",
          "sans-serif"
        ],
        "sans": [
          "Inter",
          "sans-serif"
        ]
      }
    }
  }
};</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;500;600;700;800;900&display=swap">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap">
<style>
      body {
        font-family: 'Inter', sans-serif !important;
      }
      
      /* Preserve Font Awesome icons */
      .fa, .fas, .far, .fal, .fab {
        font-family: "Font Awesome 6 Free", "Font Awesome 6 Brands" !important;
      }
    </style>
</head>
<body class="bg-light font-sans">
    <!-- Header -->
    <div class="bg-primary text-white p-4 text-center relative">
        <div class="absolute left-4 top-4">
            <a href="/dashboard" class="text-white text-xl">
                <i class="fa-solid fa-arrow-left"></i>
            </a>
        </div>
        <h1 class="text-xl font-bold">Cart</h1>
    </div>

    <!-- Cart Items -->
    <div class="p-4 space-y-3 max-h-96 overflow-y-auto" id="cart-items">
        <!-- Items will be dynamically rendered here -->
    </div>

    <!-- Action Buttons -->
    <div class="px-4 pb-4">
        <button class="w-full bg-secondary text-white py-3 rounded-lg font-medium mb-3 hover:bg-opacity-90 transition-colors" onclick="addMoreItems()">
            Add More Items
        </button>
    </div>

    <!-- Billing Summary -->
    <div class="bg-white p-4 rounded-t-3xl shadow-lg">
        <!-- Customer Selection -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Customer</label>
            <div class="relative">
                <input type="text" id="customer-search" placeholder="Search customer by name or phone..." 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                <div id="customer-suggestions" class="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg mt-1 hidden z-10 max-h-40 overflow-y-auto">
                </div>
            </div>
            <div class="flex mt-2 space-x-2">
                <button class="text-sm text-primary hover:underline" onclick="selectCashCustomer()">Cash Customer</button>
                <button class="text-sm text-primary hover:underline" onclick="showNewCustomerModal()">New Customer</button>
            </div>
            <div id="selected-customer" class="mt-2 text-sm text-gray-600"></div>
        </div>
        
        <!-- Billing Summary -->
        <div class="space-y-2 border-t pt-4">
            <div class="flex justify-between text-sm">
                <span>Subtotal:</span>
                <span id="subtotal">₹0.00</span>
            </div>
            <div class="flex justify-between text-sm">
                <span>Tax (0%):</span>
                <span id="tax">₹0.00</span>
            </div>
            <div class="flex justify-between text-sm">
                <span>Discount:</span>
                <span id="discount">₹0.00</span>
            </div>
            <div class="flex justify-between text-lg font-bold border-t pt-2">
                <span>Total:</span>
                <span id="total">₹0.00</span>
            </div>
        </div>

        <!-- Payment Mode -->
        <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Payment Mode</label>
            <div class="grid grid-cols-2 gap-2 mb-3">
                <button class="payment-mode-btn bg-primary text-white py-2 px-4 rounded-lg text-sm font-medium" onclick="selectPaymentMode('cash')" data-mode="cash">Cash</button>
                <button class="payment-mode-btn bg-gray-200 text-gray-700 py-2 px-4 rounded-lg text-sm font-medium" onclick="selectPaymentMode('online')" data-mode="online">Online</button>
                <button class="payment-mode-btn bg-gray-200 text-gray-700 py-2 px-4 rounded-lg text-sm font-medium" onclick="selectPaymentMode('split')" data-mode="split">Split</button>
                <button class="payment-mode-btn bg-gray-200 text-gray-700 py-2 px-4 rounded-lg text-sm font-medium" onclick="selectPaymentMode('credit')" data-mode="credit">Credit</button>
            </div>
            
            <!-- Payment Details (shown based on mode) -->
            <div id="payment-details" class="space-y-3 hidden">
                <div id="split-details" class="hidden">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Cash Amount</label>
                            <input type="number" id="cash-amount" class="w-full px-2 py-1 border border-gray-300 rounded text-sm" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Online Amount</label>
                            <input type="number" id="online-amount" class="w-full px-2 py-1 border border-gray-300 rounded text-sm" placeholder="0.00">
                        </div>
                    </div>
                </div>
                <div id="credit-details" class="hidden">
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <p class="text-sm text-yellow-800">
                            <i class="fa-solid fa-exclamation-triangle mr-1"></i>
                            Credit Amount: <span id="credit-amount" class="font-semibold">₹0.00</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Generate Bill Button -->
        <button class="w-full bg-primary text-white py-3 rounded-lg font-medium mt-4 hover:bg-opacity-90 transition-colors" onclick="generateBill()">
            Generate Bill
        </button>
    </div>

    <script>
        // UNIFIED CART MANAGEMENT SYSTEM
        class CartManager {
            constructor() {
                this.cartItems = {};
                this.selectedCustomer = null;
                this.selectedPaymentMode = 'cash';
                this.isInitialized = false;
                this.STORAGE_KEY = 'kiranakonnect_persistent_cart';
                this.TEMP_KEY = 'kiranakonnect_cart';
            }

            // Initialize cart - load from storage
            init() {
                if (this.isInitialized) return;
                
                console.log('Initializing cart manager...');
                
                // Load from persistent storage
                this.loadFromStorage();
                
                // Check for new items from inventory
                this.processNewItems();
                
                // Render cart
                this.render();
                
                // Calculate totals
                this.calculateTotals();
                
                this.isInitialized = true;
                console.log('Cart initialized with', Object.keys(this.cartItems).length, 'items');
            }

            // Load cart from persistent storage
            loadFromStorage() {
                try {
                    const savedData = localStorage.getItem(this.STORAGE_KEY);
                    if (savedData) {
                        const items = JSON.parse(savedData);
                        this.cartItems = {};
                        
                        items.forEach((item, index) => {
                            const id = index + 1;
                            this.cartItems[id] = {
                                id: id,
                                name: item.name,
                                price: parseFloat(item.price || 0),
                                quantity: parseFloat(item.quantity || 1),
                                unit: item.unit || 'piece',
                                unitPrice: parseFloat(item.unitPrice || 0),
                                type: item.type || 'unit',
                                mfgDate: item.mfgDate || '',
                                expDate: item.expDate || '',
                                datesHidden: item.datesHidden || false,
                                quantityDisplay: item.quantityDisplay || `${item.quantity} ${item.unit}`
                            };
                        });
                        
                        console.log('Loaded', items.length, 'items from storage');
                    } else {
                        // Initialize with default items if no storage
                        this.initializeDefaults();
                    }
                } catch (error) {
                    console.error('Error loading cart from storage:', error);
                    this.initializeDefaults();
                }
            }

            // Initialize with default sample items
            initializeDefaults() {
                this.cartItems = {
                    1: { id: 1, name: 'Aashirvaad Atta', quantity: 10, unitPrice: 45, price: 450, unit: 'Kg', type: 'unit', mfgDate: '01/05/2025', expDate: '01/09/2025', datesHidden: false, quantityDisplay: '10 Kg' },
                    2: { id: 2, name: 'Real Fruit Juice', quantity: 2, unitPrice: 60, price: 120, unit: 'Bottles', type: 'unit', mfgDate: '12/05/2025', expDate: '25/07/2025', datesHidden: false, quantityDisplay: '2 Bottles' },
                    3: { id: 3, name: 'Colgate Paste', quantity: 3, unitPrice: 30, price: 90, unit: 'Pieces', type: 'unit', quantityDisplay: '3 Pieces' },
                    4: { id: 4, name: 'Good Day Biscuits', quantity: 5, unitPrice: 12, price: 60, unit: 'Packets', type: 'unit', mfgDate: '05/03/2025', expDate: '05/09/2025', datesHidden: false, quantityDisplay: '5 Packets' },
                    5: { id: 5, name: 'Surf Excel (500gm)', quantity: 1, unitPrice: 55, price: 55, unit: 'Packet', type: 'unit', quantityDisplay: '1 Packet' },
                    6: { id: 6, name: 'Dabur Honey', quantity: 1, unitPrice: 180, price: 180, unit: 'Bottle', type: 'unit', mfgDate: '01/01/2025', expDate: '01/01/2027', datesHidden: false, quantityDisplay: '1 Bottle' }
                };
                this.saveToStorage();
                console.log('Initialized with default items');
            }

            // Process new items from inventory
            processNewItems() {
                try {
                    const tempData = localStorage.getItem(this.TEMP_KEY);
                    if (tempData) {
                        const newItems = JSON.parse(tempData);
                        if (newItems.length > 0) {
                            console.log('Processing', newItems.length, 'new items from inventory');
                            
                            newItems.forEach(item => {
                                this.addItem(item);
                            });
                            
                            // Clear temporary storage
                            localStorage.removeItem(this.TEMP_KEY);
                            
                            // Save updated cart
                            this.saveToStorage();
                            
                            console.log('Added new items. Cart now has', Object.keys(this.cartItems).length, 'items');
                        }
                    }
                } catch (error) {
                    console.error('Error processing new items:', error);
                    localStorage.removeItem(this.TEMP_KEY);
                }
            }

            // Add new item to cart
            addItem(item) {
                const existingIds = Object.keys(this.cartItems).map(Number);
                const nextId = existingIds.length > 0 ? Math.max(...existingIds) + 1 : 1;
                
                this.cartItems[nextId] = {
                    id: nextId,
                    name: item.name,
                    price: parseFloat(item.price || item.totalPrice || 0),
                    quantity: parseFloat(item.quantity || 1),
                    unit: item.unit || 'piece',
                    unitPrice: parseFloat(item.unitPrice || 0),
                    type: item.type || 'unit',
                    mfgDate: item.mfgDate || '',
                    expDate: item.expDate || '',
                    datesHidden: false,
                    quantityDisplay: item.quantityDisplay || `${item.quantity} ${item.unit}`
                };
                
                console.log('Added item:', this.cartItems[nextId]);
                return nextId;
            }

            // Remove item from cart
            removeItem(itemId) {
                if (this.cartItems[itemId]) {
                    delete this.cartItems[itemId];
                    this.saveToStorage();
                    this.render();
                    this.calculateTotals();
                    console.log('Removed item', itemId);
                }
            }

            // Save cart to persistent storage
            saveToStorage() {
                try {
                    const cartArray = Object.values(this.cartItems);
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(cartArray));
                    console.log('Cart saved to storage');
                } catch (error) {
                    console.error('Error saving cart:', error);
                }
            }

            // Render cart items in UI
            render() {
                const container = document.getElementById('cart-items');
                if (!container) return;

                container.innerHTML = '';

                Object.values(this.cartItems).forEach(item => {
                    const itemElement = this.createItemElement(item);
                    container.appendChild(itemElement);
                });

                console.log('Rendered', Object.keys(this.cartItems).length, 'cart items');
            }

            // Create DOM element for cart item
            createItemElement(item) {
                const div = document.createElement('div');
                div.className = 'bg-white rounded-xl shadow-sm p-3';
                div.id = `cart-item-${item.id}`;

                let html = `
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h3 class="font-semibold text-dark text-sm">${item.name}</h3>
                            <div class="flex justify-between items-center mt-1">
                                <span class="text-sm text-gray-700 font-medium">${item.quantityDisplay}</span>
                                <span class="text-lg font-bold text-primary">₹${item.price.toFixed(2)}</span>
                            </div>
                `;

                // Add dates if they exist
                if (item.mfgDate && item.expDate && !item.datesHidden) {
                    html += `
                            <div class="mt-2 space-y-1">
                                <div class="flex items-center text-xs text-gray-500">
                                    <i class="fa-solid fa-calendar mr-1"></i>
                                    <span>MFG: ${item.mfgDate}</span>
                                </div>
                                <div class="flex items-center text-xs text-gray-500">
                                    <i class="fa-solid fa-clock mr-1"></i>
                                    <span>EXP: ${item.expDate}</span>
                                </div>
                                <div class="flex items-center space-x-2 mt-1">
                                    <button class="text-xs text-primary hover:underline flex items-center" onclick="cartManager.editItem(${item.id})">
                                        <i class="fa-solid fa-edit mr-1"></i>
                                        Edit
                                    </button>
                                    <button class="text-xs text-danger hover:underline flex items-center" onclick="cartManager.toggleDates(${item.id})">
                                        <i class="fa-solid fa-times mr-1"></i>
                                        Remove Dates
                                    </button>
                                </div>
                            </div>
                    `;
                } else {
                    html += `
                            <div class="mt-2">
                                <button class="text-xs text-primary hover:underline flex items-center" onclick="cartManager.editItem(${item.id})">
                                    <i class="fa-solid fa-edit mr-1"></i>
                                    Edit
                                </button>
                            </div>
                    `;
                }

                html += `
                        </div>
                        <button class="text-danger text-sm ml-3 p-1" onclick="cartManager.removeItem(${item.id})">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                `;

                div.innerHTML = html;
                return div;
            }

            // Calculate and display totals
            calculateTotals() {
                const subtotal = Object.values(this.cartItems).reduce((sum, item) => sum + item.price, 0);
                const tax = 0; // No tax for now
                const discount = 0; // No discount for now
                const total = subtotal + tax - discount;

                document.getElementById('subtotal').textContent = `₹${subtotal.toFixed(2)}`;
                document.getElementById('tax').textContent = `₹${tax.toFixed(2)}`;
                document.getElementById('discount').textContent = `₹${discount.toFixed(2)}`;
                document.getElementById('total').textContent = `₹${total.toFixed(2)}`;

                // Update credit amount if needed
                if (this.selectedPaymentMode === 'credit') {
                    document.getElementById('credit-amount').textContent = `₹${total.toFixed(2)}`;
                }
            }

            // Edit item (placeholder)
            editItem(itemId) {
                console.log('Edit item', itemId);
                // TODO: Implement edit functionality
            }

            // Toggle dates visibility
            toggleDates(itemId) {
                if (this.cartItems[itemId]) {
                    this.cartItems[itemId].datesHidden = !this.cartItems[itemId].datesHidden;
                    this.saveToStorage();
                    this.render();
                }
            }
        }

        // Create global cart manager instance
        const cartManager = new CartManager();

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            cartManager.init();
            
            // Set up periodic check for new items
            setInterval(() => {
                cartManager.processNewItems();
                cartManager.render();
                cartManager.calculateTotals();
            }, 2000);
        });

        // Global functions for UI interactions
        function addMoreItems() {
            window.location.href = '/inventory';
        }

        function selectPaymentMode(mode) {
            cartManager.selectedPaymentMode = mode;
            
            // Update button styles
            document.querySelectorAll('.payment-mode-btn').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            
            document.querySelector(`[data-mode="${mode}"]`).classList.remove('bg-gray-200', 'text-gray-700');
            document.querySelector(`[data-mode="${mode}"]`).classList.add('bg-primary', 'text-white');
            
            // Show/hide payment details
            const detailsDiv = document.getElementById('payment-details');
            const splitDiv = document.getElementById('split-details');
            const creditDiv = document.getElementById('credit-details');
            
            if (mode === 'split') {
                detailsDiv.classList.remove('hidden');
                splitDiv.classList.remove('hidden');
                creditDiv.classList.add('hidden');
            } else if (mode === 'credit') {
                detailsDiv.classList.remove('hidden');
                splitDiv.classList.add('hidden');
                creditDiv.classList.remove('hidden');
                cartManager.calculateTotals();
            } else {
                detailsDiv.classList.add('hidden');
                splitDiv.classList.add('hidden');
                creditDiv.classList.add('hidden');
            }
        }

        function selectCashCustomer() {
            cartManager.selectedCustomer = { type: 'cash', name: 'Cash Customer' };
            document.getElementById('selected-customer').textContent = 'Cash Customer Selected';
        }

        function showNewCustomerModal() {
            // TODO: Implement new customer modal
            console.log('Show new customer modal');
        }

        function generateBill() {
            if (Object.keys(cartManager.cartItems).length === 0) {
                alert('Cart is empty! Please add items before generating bill.');
                return;
            }
            
            // TODO: Implement bill generation
            console.log('Generate bill with items:', cartManager.cartItems);
            alert('Bill generation functionality will be implemented soon.');
        }
    </script>
</body>
</html>